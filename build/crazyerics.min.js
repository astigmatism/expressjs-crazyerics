var FS=null,Crazyerics=function(){var e=this;$(document).ready(function(){e._clientdata=e._decompress.json(clientdata);var t=e._clientdata.openonload||{};"system"in t&&"title"in t&&"file"in t&&e._bootstrap(t.system,t.title,t.file),e._buildWelcomeMessage(),$("#searchform select").selectOrDie({customID:"selectordie",customClass:"tooltip",onChange:function(){e.replaceSuggestions($(this).val())}}),$("#searchform input").autoComplete({minChars:3,cache:!1,delay:300,source:function(t,a){var o=$("#searchform select").val();$.getJSON("/search/"+o+"/"+t,function(t){a(e._decompress.json(t))})},renderItem:function(t,a){var o=$('<div class="autocomplete-suggestion" data-title="'+t[0]+'" data-file="'+t[1]+'" data-system="'+t[2]+'" data-searchscore="'+t[3]+'"></div>');return o.append(e._getBoxFront(t[2],t[0],50)),o.append("<div>"+t[0]+"</div>"),$("<div/>").append(o).html()},onSelect:function(t,a,o){e._bootstrap(o.data("system"),o.data("title"),o.data("file"))}}),$("#emulatorwrapperoverlay").on("click",function(){$("#emulator").focus(),$("#emulatorcontrolswrapper").removeClass()}).hover(function(e){e.stopPropagation()},function(e){e.stopPropagation()}),$("#emulatorcontrolswrapper").on("mousedown mouseup click",function(e){e.preventDefault(),$("#emulator").focus()}),$("#emulatorwrapper").hover(function(e){$("#emulatorcontrolswrapper").removeClass()},function(e){$("#emulatorcontrolswrapper").addClass("closed")}),$("#gamedetailswrapper").hover(function(e){$("#gamecontrolslist").removeClass()},function(e){$("#gamecontrolslist").addClass("closed")}),$("#emulatorcontrolswrapper li.fullscreen").click(function(){e._Module.requestFullScreen(!0,!0)}),$("#emulatorcontrolswrapper li.savestate").click(function(){e._simulateEmulatorKeypress(113)}),$("#emulatorcontrolswrapper li.loadstate").click(function(){e._simulateEmulatorKeypress(115)}),$("#emulatorcontrolswrapper li.mute").click(function(){e._simulateEmulatorKeypress(120)}),$("#emulatorcontrolswrapper li.decrementslot").click(function(){e._simulateEmulatorKeypress(117)}),$("#emulatorcontrolswrapper li.incrementslot").click(function(){e._simulateEmulatorKeypress(118)}),$("#emulatorcontrolswrapper li.fastforward").click(function(){e._simulateEmulatorKeypress(70)}),$("#emulatorcontrolswrapper li.pause").click(function(){e._simulateEmulatorKeypress(80)}),$("#emulatorcontrolswrapper li.reset").click(function(){e._simulateEmulatorKeypress(72)}),$("#gamecontrolslist li.controls").on("mousedown",function(){$("#emulator").is(":focus")&&(e._pauseOverride=!0)}).on("mouseup",function(t){e._pauseOverride&&($("#emulator").focus(),e._pauseOverride=!1),$("#controlsslider").animate({width:"toggle",padding:"toggle"},500),0==$(this).attr("data-click-state")?($(this).attr("data-click-state",1),$(this).find("img").animateRotate(0,-90,500)):($(this).attr("data-click-state",0),$(this).find("img").animateRotate(-90,0,500))}),e.replaceSuggestions("all"),e._toolTips()})};Crazyerics.prototype._clientdata=null,Crazyerics.prototype._Module=null,Crazyerics.prototype._ModuleLoading=!1,Crazyerics.prototype._pauseOverride=!1,Crazyerics.prototype._activeFile=null,Crazyerics.prototype._activeSaveStateSlot=0,Crazyerics.prototype.replaceSuggestions=function(e,t){var a=this;t=t||100,$("#suggestionswrapper").hide(),$("#loading").removeClass("close"),$.getJSON("/suggest/"+e+"/"+t,function(e){e=a._decompress.json(e),$("#suggestionswrapper li").remove();for(var t=$("#suggestionswrapper ul"),o=0;o<e.length;++o){var r=a._buildGameLink(e[o].system,e[o].title,e[o].file,114);$(t[o%t.length]).append(r.li)}$("#suggestionswrapper").waitForImages().progress(function(e,t,a){$("#loading .loadingtext").text(e+"%"),e===t-1&&($("#suggestionswrapper").slideDown(),$("#loading").addClass("close"))}),a._toolTips()})},Crazyerics.prototype._bootstrap=function(e,t,a,o){var r=this;if(!r._ModuleLoading){r._ModuleLoading=!0,r._pauseOverride=!1,$("#gameloadingname").text(t),$("#gamedetailsboxfront img").addClass("close"),$("#gamedetailswrapper").fadeOut(),$("#startmessage").slideUp(1e3),$("#emulatorwrapper").slideDown(1e3),$("#gameloadingoverlaycontentimage").empty();var n=r._getBoxFront(e,t,150);n.addClass("tada"),n.load(function(){$(this).fadeIn(200)}),$("#gameloadingoverlaycontentimage").append(n),$("#gameloadingoverlay").fadeIn(500,function(){$("#gamecontrolslist li").each(function(){1==$(this).attr("data-click-state")&&$(this).mouseup()}),$("#gameloadingoverlaycontent").removeClass(),$("#emulatorcontrolswrapper").show(),r._cleanupEmulator(),$("#emulatorcanvas").append('<canvas tabindex="0" id="emulator"></canvas>');var n=$.Deferred(),i=$.Deferred(),s=$.Deferred();$.when(n,i,gameContentReady).done(function(n,i,s){var l=n[0],c=n[1],u=n[2],p=(i[0],i[1]),d=s.states;s.files;r._Module=l,FS=c,r.emulatorframe=u,console.log(r._generateLink(e,t,a)),r._setupKeypressInterceptor(e,t,a),setTimeout(function(){if(r._buildFileSystem(l,e,a,p,d),l.callMain(l.arguments),o){for(var n=0;o>n;++n)r._simulateEmulatorKeypress(118);r._simulateEmulatorKeypress(115)}r._buildGameContent(e,t,function(){}),$("#gameloadingoverlaycontent").addClass("close"),$("#gameloadingoverlay").fadeOut(1e3,function(){setTimeout(function(){r._ModuleLoading=!1,$("#emulatorcontrolswrapper").addClass("closed")},3e3)}),$("#emulator").blur(function(e){r._pauseOverride||(l.pauseMainLoop(),$("#emulatorwrapperoverlay").fadeIn())}).focus(function(){l.resumeMainLoop(),$("#emulatorwrapperoverlay").hide()}).focus()},1e3)}),r._loademulator(e,n),r._loadGame(e,t,a,i),r._loadGameDetails(e,t,a,s)})}},Crazyerics.prototype._buildGameContent=function(e,t,a){var o=this._getBoxFront(e,t,150),r=document.createElement("img");r.addEventListener("load",function(){$("#gamedetailsboxfront").empty().append(o),$("#gametitle").empty().hide().append(t);var r=this.height>200?this.height:200;$("#gamedetailsboxfront img").addClass("close"),$("#gamedetailsbackground").animate({height:r},1e3,function(){$("#gamedetailswrapper").fadeIn(1e3,function(){$("#gametitle").bigText({textAlign:"left",horizontalAlign:"left"}),$("#gametitle").fadeIn(500),$("#gamedetailsboxfront img").removeClass(),$("#controlsslider").empty(),$.get("/layout/controls/"+e,function(e){$("#controlsslider").append(e)}),a()})})},!0),o.load(function(){r.setAttribute("src",o.attr("src"))})},Crazyerics.prototype._cleanupEmulator=function(){var e=this;if($(document).unbind("fullscreenchange"),$(document).unbind("mozfullscreenchange"),$(document).unbind("webkitfullscreenchange"),$(document).unbind("pointerlockchange"),$(document).unbind("mozpointerlockchange"),$(document).unbind("webkitpointerlockchange"),e._activeSaveStateSlot=0,FS&&(FS=null),e._Module){try{e._Module.exit()}catch(t){}e._Module=null}e.emulatorframe&&(e.emulatorframe.remove(),e.emulatorframe=null),$("#emulator").remove()},Crazyerics.prototype._simulateEmulatorKeypress=function(e){var t=this;if(this._Module&&this._Module.RI&&this._Module.RI.eventHandler){var a;a=$.Event("keydown"),a.keyCode=e,a.which=e,this._Module.RI.eventHandler(a),setTimeout(function(){a=$.Event("keyup"),a.keyCode=e,a.which=e,t._Module.RI.eventHandler(a)},10),$("#emulator").focus()}},Crazyerics.prototype._setupKeypressInterceptor=function(e,t,a){var o=this;if(this._Module&&this._Module.RI&&this._Module.RI.eventHandler){var r=this._Module.RI.eventHandler;this._Module.RI.eventHandler=function(n){switch(n.type){case"keyup":var i=n.keyCode;switch(i){case 113:setTimeout(function(){o._saveState(e,t,a,o._activeSaveStateSlot,function(){})},100);break;case 117:o._activeSaveStateSlot=0===o._activeSaveStateSlot?0:o._activeSaveStateSlot-1;break;case 118:o._activeSaveStateSlot++}}r(n)}}},Crazyerics.prototype._loademulator=function(e,t){var a=$("<iframe/>",{src:"/load/emulator/"+e,style:"display:none",load:function(){var e=this.contentWindow.FS,o=this.contentWindow.Module;t.resolve(o,e,a)}});$("body").append(a)},Crazyerics.prototype._loadGame=function(e,t,a,o){$.get("/load/"+e+"/"+t+"/"+a,function(e){var t;try{t=pako.inflate(e)}catch(a){return void o.resolve(a)}o.resolve(null,t)})},Crazyerics.prototype._loadGameDetails=function(e,t,a,o){var r=this;$.get("/states/"+e+"/"+t+"/"+a,function(e){o.resolve({states:e.states,files:r._decompress.json(e.files)})})},Crazyerics.prototype._buildFileSystem=function(e,t,a,o,r){var n=this;e.FS_createDataFile("/",a,o,!0,!0),e.arguments=["-v","/"+a],e.FS_createFolder("/","etc",!0,!0),n._clientdata.retroarchconfig&&n._clientdata.retroarchconfig[t]&&e.FS_createDataFile("/etc","retroarch.cfg",n._clientdata.retroarchconfig[t],!0,!0);for(var i in r){var s=n._decompress.bytearray(r[i]),l=a.replace(new RegExp(".[a-z]{1,3}$","gi"),""),c="/"+l+".state"+(0==i?"":i);e.FS_createDataFile("/",c,s,!0,!0)}},Crazyerics.prototype._saveState=function(e,t,a,o,r){var n,i=this,s=a.replace(new RegExp(".[a-z]{1,3}$","gi"),""),l=s+".state"+(0==o?"":o);try{n=FS.open(l)}catch(c){return void console.log(c)}if(n&&n.node&&n.node.contents){var u=i._compress.bytearray(n.node.contents);$.ajax({url:"/states/"+e+"/"+t+"/"+a+"/"+o,data:u,processData:!1,contentType:"text/plain",type:"POST",success:function(e){}})}},Crazyerics.prototype._buildWelcomeMessage=function(){var e=this,t=e._getPlayHistory(5);if(0===t.length)return void $("#startfirst").animate({height:"toggle",opacity:"toggle"},200);for(var a=0;a<t.length;++a){var o=e._buildGameLink(t[a].system,t[a].title,t[a].file,114,!0);!function(e,t,a,o){o.li.addClass("close"),o.img.load(function(){o.li.removeClass("close")}),o.remove.addClass("tooltip").attr("title","Remove this game and all saved states").on("click",function(){o.li.addClass("close"),$.ajax({url:"/states/"+e+"/"+t+"/"+a,type:"DELETE",success:function(){}})})}(t[a].system,t[a].title,t[a].file,o),$("#startplayed ul").append(o.li)}$("#startplayed").animate({height:"toggle",opacity:"toggle"},200),e._toolTips()},Crazyerics.prototype._buildGameLink=function(e,t,a,o,r){var n=this;r=r||!1;var i=$('<li class="gamelink"></li>'),s=n._getBoxFront(e,t,o);s.addClass("tooltip close"),s.attr("title",t),s.attr("data-system",e),s.attr("data-title",t),s.attr("data-file",a),s.load(function(){$(this).removeClass("close").on("mousedown",function(){n._pauseOverride=!0}).on("mouseup",function(){n._bootstrap(this.dataset.system,this.dataset.title,this.dataset.file),window.scrollTo(0,0)})}),i.append(s);var l=null;return r&&(l=$('<div class="remove"></div>'),i.append(l).on("mouseover",function(){$(l).show()}).on("mouseout",function(){$(l).hide()})),{li:i,img:s,remove:l}},Crazyerics.prototype._getBoxFront=function(e,t,a){return $("<img onerror=\"this.src='/images/blanks/"+e+"_"+a+'.png\'" src="/images/games/'+e+"/"+t+"/"+a+'.jpg" />')},Crazyerics.prototype._toolTips=function(){$(".tooltip").tooltipster({theme:"tooltipster-shadow",animation:"grow",delay:100})},Crazyerics.prototype._getPlayHistory=function(e){var t=this,a=[];if(t._clientdata&&t._clientdata.playhistory){var o=t._clientdata.playhistory,r=Object.keys(o);e=e||r.length,r.sort(function(e,t){return t>e});for(var n=0;n<r.length&&e>n;++n)o[r[n]].played=r[n],a.push(o[r[n]])}return a},Crazyerics.prototype._generateLink=function(e,t,a){return this._compress.string(encodeURI(e+"/"+t+"/"+a))},Crazyerics.prototype._compress={bytearray:function(e){var t=pako.deflate(e);return btoa(String.fromCharCode.apply(null,t))},json:function(e){return btoa(pako.deflate(JSON.stringify(e),{to:"string"}))},string:function(e){return btoa(pako.deflate(e,{to:"string"}))}},Crazyerics.prototype._decompress={bytearray:function(e){var t=new Uint8Array(atob(e).split("").map(function(e){return e.charCodeAt(0)}));return pako.inflate(t)},json:function(e){return JSON.parse(pako.inflate(atob(e),{to:"string"}))}},$.fn.animateRotate=function(e,t,a,o,r){var n=$.speed(a,o,r),i=n.step;return this.each(function(a,o){n.complete=$.proxy(n.complete,o),n.step=function(e){return $.style(o,"transform","rotate("+e+"deg)"),i?i.apply(o,arguments):void 0},$({deg:e}).animate({deg:t},n)})};var crazyerics=new Crazyerics;