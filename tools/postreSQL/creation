-- User: crazyerics
-- DROP USER crazyerics;

CREATE USER crazyerics WITH
  LOGIN
  NOSUPERUSER
  INHERIT
  NOCREATEDB
  NOCREATEROLE
  NOREPLICATION;

----------------------------------

-- Database: crazyerics

-- DROP DATABASE crazyerics;

CREATE DATABASE crazyerics
    WITH 
    OWNER = crazyerics
    ENCODING = 'UTF8'
    LC_COLLATE = 'en_GB.UTF-8'
    LC_CTYPE = 'en_GB.UTF-8'
    TABLESPACE = pg_default
    CONNECTION LIMIT = -1;

----------------------------------

CREATE TABLE "sessions" (
    "sid" varchar NOT NULL COLLATE "default",
	"sess" json NOT NULL,
	"expire" timestamp(6) NOT NULL
)
WITH (OIDS=FALSE);
ALTER TABLE "sessions" ADD CONSTRAINT "session_pkey" PRIMARY KEY ("sid") NOT DEFERRABLE INITIALLY IMMEDIATE;
ALTER TABLE "sessions" OWNER to crazyerics;

GRANT ALL ON TABLE public.sessions TO crazyerics;

ALTER TABLE public.sessions
    ALTER COLUMN sess DROP NOT NULL;

ALTER TABLE public.sessions
    ALTER COLUMN expire DROP NOT NULL;

----------------------------------

CREATE SEQUENCE public.users_user_id_seq
    INCREMENT 1
    START 1
;

ALTER SEQUENCE public.users_user_id_seq
    OWNER TO crazyerics;

----------------------------------

-- Table: public.users

-- DROP TABLE public.users;

CREATE TABLE public.users
(
    user_id integer NOT NULL DEFAULT nextval('users_user_id_seq'::regclass),
    user_name character(80) COLLATE pg_catalog."default",
    email_address character(80) COLLATE pg_catalog."default",
    CONSTRAINT users_pkey PRIMARY KEY (user_id)
)
WITH (
    OIDS = FALSE
)
TABLESPACE pg_default;

ALTER TABLE public.users
    OWNER to crazyerics;

ALTER TABLE public.users
    ADD COLUMN created timestamp(10) without time zone;

GRANT ALL ON TABLE public.users TO crazyerics;

GRANT ALL ON SEQUENCE public.users_user_id_seq TO crazyerics;

INSERT INTO users (user_id, user_name) VALUES (0, 'application');

----------------------------------


-- Table: public.users_sessions

-- DROP TABLE public.users_sessions;

CREATE TABLE public.users_sessions
(
    user_id bigint NOT NULL,
    sid character varying COLLATE pg_catalog."default" NOT NULL,
    last_activity date,
    CONSTRAINT users_sessions_pkey PRIMARY KEY (user_id, sid),
    CONSTRAINT fk_sid FOREIGN KEY (sid)
        REFERENCES public.sessions (sid) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE,
    CONSTRAINT fk_user_id FOREIGN KEY (user_id)
        REFERENCES public.users (user_id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION
)
WITH (
    OIDS = FALSE
)
TABLESPACE pg_default;

ALTER TABLE public.users_sessions
    OWNER to crazyerics;

GRANT ALL ON TABLE public.users_sessions TO crazyerics;

----------------------------------

CREATE TABLE public.systems
(
    system_id character varying(10) NOT NULL,
    name character varying(80) NOT NULL,
    created timestamp without time zone NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT pk_system_id PRIMARY KEY (system_id)
)
WITH (
    OIDS = FALSE
);

ALTER TABLE public.systems
    OWNER to crazyerics;

GRANT ALL ON TABLE public.systems TO crazyerics;

----------------------------------

CREATE TABLE public.titles
(
    title_id serial NOT NULL,
    system_id character varying(10) NOT NULL,
    name text NOT NULL,
    created timestamp(10) without time zone NOT NULL,
    CONSTRAINT pk_title_id PRIMARY KEY (title_id),
    CONSTRAINT fk_system_id FOREIGN KEY (system_id)
        REFERENCES public.systems (system_id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE
)
WITH (
    OIDS = FALSE
);

ALTER TABLE public.titles
    OWNER to crazyerics;

GRANT ALL ON TABLE public.titles TO crazyerics;

GRANT ALL ON SEQUENCE public.titles_title_id_seq TO crazyerics;

ALTER TABLE public.titles
    ALTER COLUMN created SET DEFAULT CURRENT_TIMESTAMP;

ALTER TABLE public.titles
    ALTER COLUMN system_id TYPE character varying (10);

----------------------------------

CREATE TABLE public.files
(
    file_id serial NOT NULL,
    title_id integer NOT NULL,
    name text NOT NULL,
    play_count integer NOT NULL,
    last_played timestamp(10) without time zone,
    CONSTRAINT pk_file_id PRIMARY KEY (file_id),
    CONSTRAINT fk_title_id FOREIGN KEY (title_id)
        REFERENCES public.titles (title_id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE
)
WITH (
    OIDS = FALSE
);

ALTER TABLE public.files
    OWNER to crazyerics;

GRANT ALL ON TABLE public.files TO crazyerics;

GRANT ALL ON SEQUENCE public.files_file_id_seq TO crazyerics;

ALTER TABLE public.files
    ALTER COLUMN play_count SET DEFAULT 0;

ALTER TABLE public.files
    ADD COLUMN created timestamp(10) without time zone NOT NULL;

ALTER TABLE public.files
    ALTER COLUMN created SET DEFAULT CURRENT_TIMESTAMP;

----------------------------------

CREATE SEQUENCE public.saves_save_id_seq
    INCREMENT 1
    START 1
;

ALTER SEQUENCE public.saves_save_id_seq
    OWNER TO crazyerics;


----------------------------------

-- Table: public.saves

-- DROP TABLE public.saves;

CREATE TABLE public.saves
(
    save_id integer NOT NULL DEFAULT nextval('saves_save_id_seq'::regclass),
    file_id integer NOT NULL,
    created timestamp(6) without time zone NOT NULL DEFAULT now(),
    type character varying(10) COLLATE pg_catalog."default" NOT NULL,
    screenshot text COLLATE pg_catalog."default",
    save text COLLATE pg_catalog."default" NOT NULL,
    public boolean NOT NULL DEFAULT false,
    comment text COLLATE pg_catalog."default",
    client_timestamp bigint NOT NULL,
    user_id integer NOT NULL,
    CONSTRAINT pk_save_id PRIMARY KEY (save_id),
    CONSTRAINT fk_file_id FOREIGN KEY (file_id)
        REFERENCES public.files (file_id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE,
    CONSTRAINT fk_user_id FOREIGN KEY (user_id)
        REFERENCES public.users (user_id) MATCH SIMPLE
        ON UPDATE CASCADE
        ON DELETE CASCADE
)
WITH (
    OIDS = FALSE
)
TABLESPACE pg_default;

ALTER TABLE public.saves
    OWNER to crazyerics;

GRANT ALL ON TABLE public.saves TO crazyerics;

----------------------------------

CREATE SEQUENCE public.collections_collection_id_seq
    INCREMENT 1
    START 1
;

ALTER SEQUENCE public.collections_collection_id_seq
    OWNER TO crazyerics;

----------------------------------

-- Table: public.collections

-- DROP TABLE public.collections;

CREATE TABLE public.collections
(
    collection_id integer NOT NULL DEFAULT nextval('collections_collection_id_seq'::regclass),
    user_id integer NOT NULL,
    created timestamp(6) without time zone NOT NULL DEFAULT now(),
    name character varying(80) COLLATE pg_catalog."default" NOT NULL,
    comment text COLLATE pg_catalog."default",
    public boolean NOT NULL DEFAULT false,
    sort character varying(20) COLLATE pg_catalog."default",
    "asc" boolean,
    CONSTRAINT pk_collection_id PRIMARY KEY (collection_id),
    CONSTRAINT fk_user_id FOREIGN KEY (user_id)
        REFERENCES public.users (user_id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE
)
WITH (
    OIDS = FALSE
)
TABLESPACE pg_default;

ALTER TABLE public.collections
    OWNER to crazyerics;

GRANT ALL ON TABLE public.collections TO crazyerics;

----------------------------------

CREATE TABLE public.users_titles
(
    user_id integer NOT NULL,
    title_id integer NOT NULL,
    user_title_id serial NOT NULL,
    created timestamp(6) without time zone NOT NULL,
    play_count integer NOT NULL DEFAULT 1,
    last_played timestamp(6) without time zone NOT NULL,
    active_file integer NOT NULL,
    game_key text,
    CONSTRAINT pk_user_title_id PRIMARY KEY (user_title_id),
    CONSTRAINT fk_title_id FOREIGN KEY (title_id)
        REFERENCES public.titles (title_id) MATCH SIMPLE
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    CONSTRAINT fk_user_id FOREIGN KEY (user_id)
        REFERENCES public.users (user_id) MATCH SIMPLE
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    CONSTRAINT fk_active_file FOREIGN KEY (active_file)
        REFERENCES public.files (file_id) MATCH SIMPLE
        ON UPDATE CASCADE
        ON DELETE CASCADE
)
WITH (
    OIDS = FALSE
);

ALTER TABLE public.users_titles
    OWNER to crazyerics;

GRANT ALL ON SEQUENCE public.users_titles_user_title_id_seq TO crazyerics;

GRANT ALL ON TABLE public.users_titles TO crazyerics;

ALTER TABLE public.users_titles
    ALTER COLUMN created SET DEFAULT now();

ALTER TABLE public.users_titles
    ADD COLUMN top_ranked boolean DEFAULT True;

----------------------------------

CREATE TABLE public.collections_titles
(
    collection_id integer NOT NULL,
    title_id integer NOT NULL,
    CONSTRAINT pk_collections_titles PRIMARY KEY (collection_id, title_id),
    CONSTRAINT fk_collection_id FOREIGN KEY (collection_id)
        REFERENCES public.collections (collection_id) MATCH SIMPLE
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    CONSTRAINT fk_title_id FOREIGN KEY (title_id)
        REFERENCES public.titles (title_id) MATCH SIMPLE
        ON UPDATE CASCADE
        ON DELETE CASCADE
)
WITH (
    OIDS = FALSE
);

ALTER TABLE public.collections_titles
    OWNER to crazyerics;

GRANT ALL ON TABLE public.collections_titles TO crazyerics;

----------------------------------

-- Table: public.collections_active

-- DROP TABLE public.collections_active;

CREATE TABLE public.collections_active
(
    user_id integer NOT NULL,
    collection_id integer NOT NULL,
    CONSTRAINT collections_active_pkey PRIMARY KEY (user_id),
    CONSTRAINT fk_collection_id FOREIGN KEY (collection_id)
        REFERENCES public.collections (collection_id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE,
    CONSTRAINT fk_user_id FOREIGN KEY (user_id)
        REFERENCES public.users (user_id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE
)
WITH (
    OIDS = FALSE
)
TABLESPACE pg_default;

ALTER TABLE public.collections_active
    OWNER to crazyerics;

GRANT ALL ON TABLE public.collections_active TO crazyerics;

----------------------------------