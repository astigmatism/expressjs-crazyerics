var FS=null,Crazyerics=function(){var a=this;$(document).ready(function(){a._clientdata=a._decompress.json(clientdata);var d=a._clientdata.openonload||{};"system"in d&&"title"in d&&"file"in d&&a._bootstrap(d.system,d.title,d.file);a._buildRecentlyPlayed(a._clientdata.playhistory);$("#searchform select").selectOrDie({customID:"selectordie",customClass:"tooltip",onChange:function(){a.replaceSuggestions($(this).val())}});$("#searchform input").autoComplete({minChars:3,cache:!1,delay:300,source:function(b,
d){var c=$("#searchform select").val();$.getJSON("/search/"+c+"/"+b,function(b){d(a._decompress.json(b))})},renderItem:function(b,d){var c=$('<div class="autocomplete-suggestion" data-title="'+b[0]+'" data-file="'+b[1]+'" data-system="'+b[2]+'" data-searchscore="'+b[3]+'"></div>');c.append(a._getBoxFront(b[2],b[0],50));c.append("<div>"+b[0]+"</div>");return $("<div/>").append(c).html()},onSelect:function(b,d,c){a._bootstrap(c.data("system"),c.data("title"),c.data("file"))}});$("#emulatorwrapperoverlay").on("click",
function(){$("#emulator").focus();$("#emulatorcontrolswrapper").removeClass()}).hover(function(a){a.stopPropagation()},function(a){a.stopPropagation()});$("#emulatorcontrolswrapper").on("mousedown mouseup click",function(a){a.preventDefault();$("#emulator").focus()});$("#emulatorwrapper").hover(function(a){$("#emulatorcontrolswrapper").removeClass()},function(a){$("#emulatorcontrolswrapper").addClass("closed")});$("#gamedetailswrapper").hover(function(a){$("#gamecontrolslist").removeClass()},function(a){$("#gamecontrolslist").addClass("closed")});
$("#emulatorcontrolswrapper li.fullscreen").click(function(){a._simulateEmulatorKeypress(70)});$("#emulatorcontrolswrapper li.savestate").click(function(){a._simulateEmulatorKeypress(49)});$("#emulatorcontrolswrapper li.loadstate").click(function(){a._simulateEmulatorKeypress(52)});$("#emulatorcontrolswrapper li.mute").click(function(){a._simulateEmulatorKeypress(77)});$("#emulatorcontrolswrapper li.decrementslot").click(function(){a._simulateEmulatorKeypress(50)});$("#emulatorcontrolswrapper li.incrementslot").click(function(){a._simulateEmulatorKeypress(51)});
$("#emulatorcontrolswrapper li.fastforward").click(function(){a._simulateEmulatorKeypress(32)});$("#emulatorcontrolswrapper li.pause").click(function(){a._simulateEmulatorKeypress(80)});$("#emulatorcontrolswrapper li.reset").click(function(){a._simulateEmulatorKeypress(72)});$("#emulatorcontrolswrapper li.rewind").click(function(){a._simulateEmulatorKeypress(82,5E3)});a.Sliders.init();a.replaceSuggestions("all");a._toolTips()})};
Crazyerics.prototype.Sliders={_animating:!1,_animationRate:250,init:function(){this._bind()},_bind:function(){var a=this;$("#gamecontrolslist li").on("mousedown mouseup click",function(a){a.preventDefault();$("#emulator").focus()}).on("mouseup",function(d){a.open($(this).attr("class"))})},open:function(a,d){if(!this._animating){var b=this;d=d||!1;this._animating=!0;$("#gamecontrolslist li").each(function(e,c){var f=$("#"+$(this).attr("class"));if($(c).hasClass(a)){var g=function(){setTimeout(function(){b._toggle(c,
f,function(){b._animating=!1})},b._animationRate)};$(f).hasClass("closed")?($(f).removeClass("closed"),g()):d?b._animating=!1:($(f).addClass("closed"),g())}else $(f).hasClass("closed")||($(f).addClass("closed"),b._toggle(c,f))})}},closeall:function(){var a=this;this.open("");setTimeout(function(){a._animating=!1},a._animationRate)},_toggle:function(a,d,b){b=b||null;$(d).animate({width:"toggle",padding:"toggle"},this._animationRate,function(){b&&b()});0==$(a).attr("data-click-state")?($(a).attr("data-click-state",
1),$(a).find("img").animateRotate(0,90,this._animationRate)):($(a).attr("data-click-state",0),$(a).find("img").animateRotate(90,0,this._animationRate))}};Crazyerics.prototype._clientdata=null;Crazyerics.prototype._Module=null;Crazyerics.prototype._ModuleLoading=!1;Crazyerics.prototype._pauseOverride=!1;Crazyerics.prototype._activeFile=null;Crazyerics.prototype._keypresslocked=!1;Crazyerics.prototype._fileWriteDelay=500;Crazyerics.prototype._tips="Back out of that mistake you made by holding the R key to rewind the game;Press the Space key to fast forward through those boring story scenes;If your browser supports it, you can go fullscreen by pressing the F key;You can save your progress by pressing the 1 key, return to it anytime with the 4 key;We'll store all of your save states as long as you return within two weeks;Pause your game with the P key;Select a system filter to generate a new list of suggested games;To search for more obsurace or forgeign titles, select a system filter first;Take a screenshot with the T key. Missed that moment? Rewind with R and capture again!;Screenshots are deleted when you leave or refresh the page. Download your favorites to keep them!".split(";");
Crazyerics.prototype._fileWriteTimers={};Crazyerics.prototype._playhistory={};Crazyerics.prototype._socket=null;Crazyerics.prototype._macroToShaderMenu=[[112,100],40,40,40,88,88,40,40,40,37,37,37,38,88];
Crazyerics.prototype.replaceSuggestions=function(a,d){var b=this;d=d||100;$("#suggestionswrapper").hide();$("#loading").removeClass("close");$.getJSON("/suggest/"+a+"/"+d,function(a){a=b._decompress.json(a);$("#suggestionswrapper li").remove();for(var c=$("#suggestionswrapper ul"),d=0;d<a.length;++d){var g=b._buildGameLink(a[d].system,a[d].title,a[d].file,120);$(c[d%c.length]).append(g.li)}$("#suggestionswrapper").waitForImages().progress(function(a,b,c){$("#loading .loadingtext").text(a+"%");a===
b-1&&($("#suggestionswrapper").slideDown(),$("#loading").addClass("close"))});b._toolTips()})};
Crazyerics.prototype._bootstrap=function(a,d,b,e){var c=this,f=c._compress.gamekey(a,d,b);if(!c._ModuleLoading){c._ModuleLoading=!0;c._pauseOverride=!1;$("#gameloadingname").text(d);$("#gamedetailsboxfront img").addClass("close");$("#gamedetailswrapper").fadeOut();$("#startmessage").slideUp(1E3);$("#emulatorwrapper").slideDown(1E3);$("#gameloadingoverlaycontentimage").empty();var g=c._getBoxFront(a,d,170);g.addClass("tada");g.load(function(){$(this).fadeIn(200)});$("#gameloadingoverlaycontentimage").append(g);
var h=setInterval(function(){$("#tip").fadeOut(500,function(){var a=Crazyerics.prototype._tips[Math.floor(Math.random()*Crazyerics.prototype._tips.length)];$("#gameloadingoverlay").is(":animated")||$("#tip").empty().append("Tip: "+a).fadeIn(500)})},5E3);$("#gamedetailsbackground").animate({height:0},500);$("#gameloadingoverlay").fadeIn(500,function(){c.Sliders.closeall();$("#gameloadingoverlaycontent").show().removeClass();$("#emulatorcontrolswrapper").show();$("#gameloadfailure").hide();c._cleanupEmulator();
$("#emulatorcanvas").append('<canvas tabindex="0" id="emulator"></canvas>');var g=$.Deferred(),m=$.Deferred(),n=$.Deferred();$.when(g,m,n).done(function(g,k,m){if("nes"===a)$("#gameloadingoverlaycontent").hide(),$("#gameloadfailure").empty().append("<h2>Crazyerics cannot play NES games at this time</h2><p>Sorry for the inconvenience! I'm a huge NES fanboy myself and hope to have this up soon.</p>").show(),c._ModuleLoading=!1;else{var l=g[0],n=g[1];g=g[2];k=k[1];m=m.states;c._Module=l;FS=n;c.emulatorframe=
g;c._setupKeypressInterceptor(a,d,b);c._buildFileSystem(l,a,b,k,m);l.emulatorFileWritten=function(e,g){c._emulatorFileWriteListener(f,a,d,b,e,g)};l.callMain(l.arguments);var p=function(){c._buildGameContent(a,d,function(){});$("#gameloadingoverlaycontent").addClass("close");$("#gameloadingoverlay").fadeOut(1E3,function(){$("#tips").stop().hide();clearInterval(h);setTimeout(function(){c._ModuleLoading=!1;$("#emulatorcontrolswrapper").addClass("closed");c.Sliders.open("controlsslider")},1E3)});$("#emulator").blur(function(a){c._pauseOverride||
(l.pauseMainLoop(),$("#emulatorwrapperoverlay").fadeIn())}).focus(function(){l.resumeMainLoop();$("#emulatorwrapperoverlay").hide()}).focus()};e?c._asyncLoop(parseInt(e,10),function(a){c._simulateEmulatorKeypress(51,10,function(){a.next()})},function(){c._simulateEmulatorKeypress(52);p()}):p()}});c._loademulator(a,g);c._loadGameData(f,a,d,b,m);c._loadGame(f,a,d,b,n)})}};
Crazyerics.prototype._buildGameContent=function(a,d,b){var e=this._getBoxFront(a,d,170),c=document.createElement("img");c.addEventListener("load",function(){$("#gamedetailsboxfront").empty().append(e);$("#gametitle").empty().hide().append(d);$("#gamedetailsboxfront img").addClass("close");$("#gamedetailsbackground").animate({height:250},1E3,function(){$("#gamedetailswrapper").fadeIn(1E3,function(){$("#gamedetailsboxfront img").removeClass();$("#controlsslider").empty();$.get("/layout/controls/"+a,
function(a){$("#controlsslider").append(a)});b()});$("#gametitle").bigText({textAlign:"left",horizontalAlign:"left"})})},!0);e.load(function(){c.setAttribute("src",e.attr("src"))})};
Crazyerics.prototype._cleanupEmulator=function(){$(document).unbind("fullscreenchange");$(document).unbind("mozfullscreenchange");$(document).unbind("webkitfullscreenchange");$(document).unbind("pointerlockchange");$(document).unbind("mozpointerlockchange");$(document).unbind("webkitpointerlockchange");FS&&(FS=null);if(this._Module){try{this._Module.exit()}catch(a){}this._Module=null}this.emulatorframe&&(this.emulatorframe.remove(),this.emulatorframe=null);$("#emulator").remove()};
Crazyerics.prototype._simulateEmulatorKeypress=function(a,d,b){var e=this;d=d||10;if(this._Module&&this._Module.RI&&this._Module.RI.eventHandler&&!e._keypresslocked){e._keypresslocked=!0;var c;c=$.Event("keydown");c.keyCode=a;c.which=a;this._Module.RI.eventHandler(c);setTimeout(function(){c=$.Event("keyup");c.keyCode=a;c.which=a;e._Module.RI.eventHandler(c);setTimeout(function(){e._keypresslocked=!1;b&&b()},100)},d);$("#emulator").focus()}};
Crazyerics.prototype._runKeyboardMacro=function(a,d){var b=this;if($.isArray(a)&&0!==a.length){var e=a[0];$.isArray(e)&&(e=e[0]);b._simulateEmulatorKeypress(e,1,function(){b._runKeyboardMacro(a.slice(1),d)})}else d&&d()};
Crazyerics.prototype._setupKeypressInterceptor=function(a,d,b){var e=this;if(this._Module&&this._Module.RI&&this._Module.RI.eventHandler){var c=this._Module.RI.eventHandler;this._Module.RI.eventHandler=function(a){switch(a.type){case "keyup":switch(a.keyCode){case 70:e._Module.requestFullScreen(!0,!0);break;case 67:e.getShader("super-eagle")}}c(a)}}};
Crazyerics.prototype._loademulator=function(a,d){var b=$("<iframe/>",{src:"/load/emulator/"+a,style:"display:none",load:function(){var a=this.contentWindow.FS,c=this.contentWindow.Module;c.monitorRunDependencies=function(f){0===f&&d.resolve(c,a,b)};0===c.totalDependencies&&d.resolve(c,a,b)}});$("body").append(b)};
Crazyerics.prototype._loadGameData=function(a,d,b,e,c){var f=this._clientdata.rompath;this._clientdata.flattenedromfiles?(a=this._compress.json({0:b,1:e}),f+="/"+d+"/"+encodeURIComponent(encodeURIComponent(a))):f+="/"+d+"/"+b+"/"+e;$.get(f,function(a){var b;try{b=pako.inflate(a)}catch(d){c.resolve(d);return}c.resolve(null,b)})};
Crazyerics.prototype._loadGame=function(a,d,b,e,c){var f=this;$.get("/load/game?key="+encodeURIComponent(a),function(g){f._addToPlayHistory(a,d,b,e);c.resolve({states:g.states,files:f._decompress.json(g.files)})})};
Crazyerics.prototype._buildFileSystem=function(a,d,b,e,c){a.FS_createDataFile("/",b,e,!0,!0);a.arguments=["-v","/"+b];a.FS_createFolder("/","etc",!0,!0);this._clientdata.retroarch&&this._clientdata.retroarch[d]&&a.FS_createDataFile("/etc","retroarch.cfg",this._clientdata.retroarch[d],!0,!0);a.FS_createFolder("/","shaders",!0,!0);a.FS_createFolder("/","screenshots",!0,!0);for(var f in c)d=this._decompress.bytearray(c[f]),e="/"+b.replace(RegExp(".[a-z0-9]{1,3}$","gi"),"")+".state"+(0==f?"":f),a.FS_createDataFile("/",
e,d,!0,!0)};Crazyerics.prototype.getShader=function(a,d){var b=this,e=b._Module;e&&e.FS_createDataFile&&e.FS_createFolder&&$.getJSON("/shaders/"+a,function(a){for(file in a){var d=b._decompress.bytearray(a[file]);console.log(d)}})};
Crazyerics.prototype._emulatorFileWritten=function(a,d,b,e,c,f){var g=this,h=c.match(/\.state(\d*)$/);c=c.match(/\.bmp$/);if(h){var k=""===h[1]?0:h[1],h=g._compress.bytearray(f);$.ajax({url:"/states/save?key="+encodeURIComponent(a)+"&slot="+k,data:h,processData:!1,contentType:"text/plain",type:"POST",complete:function(c){c={};c[k]=Date.now();g._addToPlayHistory(a,d,b,e,null,c)}})}c&&($("p.screenshothelper").remove(),h=g._clientdata.retroarch[d].match(/video_aspect_ratio = (\d+\.+\d+)/),h=$.isArray(h)&&
1<h.length?parseFloat(h[1]):1,f=new Uint8Array(f),f=new Blob([f],{type:"image/bmp"}),f=(window.URL||window.webkitURL).createObjectURL(f),c=$("#screenshotsslider div.slidercontainer").width()/3,h=new Image(c,c/h),h.src=f,$(h).addClass("close").load(function(){$(this).removeClass("close")}),$('<a class="screenshotthumb" href="'+f+'" download></a>').append(h).insertAfter("#screenshotsslider p"),g.Sliders.open("screenshotsslider",!0))};
Crazyerics.prototype._emulatorFileWriteListener=function(a,d,b,e,c,f){var g=this;g._fileWriteTimers.hasOwnProperty(c)&&clearTimeout(g._fileWriteTimers[c]);g._fileWriteTimers[c]=setTimeout(function(){delete g._fileWriteTimers[c];g._emulatorFileWritten(a,d,b,e,c,f)},g._fileWriteDelay)};
Crazyerics.prototype._buildRecentlyPlayed=function(a,d){for(var b in a)this._addToPlayHistory(b,a[b].system,a[b].title,a[b].file,a[b].played,a[b].slots);$.isEmptyObject(a)?$("#startfirst").animate({height:"toggle",opacity:"toggle"},500):$("#startplayed").animate({height:"toggle",opacity:"toggle"},500)};
Crazyerics.prototype._addToPlayHistory=function(a,d,b,e,c,f){var g;if(a in this._playhistory){if(this._playhistory[a].played=Date.now(),f)for(g in f)this._addStateToPlayHistory(this._playhistory[a],this._playhistory[a].stateswrapper,g,f[g])}else{var h=this._buildGameLink(d,b,e,120,!0,f);h.li.addClass("close");h.img.load(function(){h.li.removeClass("close")});h.remove.addClass("tooltip").attr("title","Remove this game and all saved states").on("click",function(){h.li.addClass("slideup");$.ajax({url:"/states/delete?key="+
encodeURIComponent(a),type:"DELETE",complete:function(){setTimeout(function(){h.li.remove()},500)}})});var k=$('<div class="statewrapper"></div>');h.li.append(k);this._playhistory[a]={system:d,title:b,file:e,played:c||Date.now(),slots:f||{},stateswrapper:k};if(f)for(g in f)this._addStateToPlayHistory(this._playhistory[a],k,g,f[g]);d=$("#recentplayedwrapper ul");b=d[0];for(e=0;e<d.length;++e)b=$(d[e]).children().length<$(b).children().length?d[e]:b;$(b).append(h.li);$("#recentplayedwrapper").show()}this._toolTips()};
Crazyerics.prototype._addStateToPlayHistory=function(a,d,b,e){var c=this;e=new Date(e);e=$.format.date(e,"E MM/dd/yyyy h:mm:ss a");var f=$('<div data-slot="'+b+'" class="statebutton zoom tooltip" title="Load State Saved '+e+'">'+b+"</div>").on("mousedown",function(){c._pauseOverride=!0}).on("mouseup",function(){c._bootstrap(a.system,a.title,a.file,b);window.scrollTo(0,0)}),g=!1;d.children().each(function(){var a=parseInt($(this).attr("data-slot"),10);b=parseInt(b,10);if(a===b)return f.insertBefore(this),
$(this).remove(),g=!0,!1;if(a>b)return f.insertBefore(this),g=!0,!1});g||d.append(f)};
Crazyerics.prototype._buildGameLink=function(a,d,b,e,c){var f=this;c=c||!1;var g=$('<li class="gamelink"></li>');e=f._getBoxFront(a,d,e);e.addClass("tooltip close");e.attr("title",d);e.load(function(){$(this).removeClass("close").on("mousedown",function(){f._pauseOverride=!0}).on("mouseup",function(){f._bootstrap(a,d,b);window.scrollTo(0,0)})});var h=$('<div class="box zoom"></div>');h.append(e);g.append(h);var k=null;c&&(k=$('<div class="remove"></div>'),h.append(k).on("mouseover",function(){$(k).show()}).on("mouseout",
function(){$(k).hide()}));return{li:g,img:e,remove:k}};Crazyerics.prototype._getBoxFront=function(a,d,b){this._clientdata.flattenedboxfiles&&(d=encodeURIComponent(encodeURIComponent(this._compress.string(d))));return $("<img onerror=\"this.src='"+this._clientdata.assetpath+"/images/blanks/"+a+"_"+b+'.png\'" src="'+this._clientdata.boxpath+"/"+a+"/"+d+"/"+b+'.jpg" />')};Crazyerics.prototype._toolTips=function(){$(".tooltip").tooltipster({theme:"tooltipster-shadow",animation:"grow",delay:100})};
Crazyerics.prototype._generateLink=function(a,d,b){return this._compress.string(encodeURI(a+"/"+d+"/"+b))};Crazyerics.prototype._compress={bytearray:function(a){a=pako.deflate(a,{to:"string"});return btoa(a)},json:function(a){a=JSON.stringify(a);a=pako.deflate(a,{to:"string"});return btoa(a)},string:function(a){a=pako.deflate(a,{to:"string"});return btoa(a)},gamekey:function(a,d,b){return this.json({system:a,title:d,file:b})}};
Crazyerics.prototype._decompress={bytearray:function(a){a=new Uint8Array(atob(a).split("").map(function(a){return a.charCodeAt(0)}));return pako.inflate(a)},json:function(a){a=atob(a);a=pako.inflate(a,{to:"string"});return JSON.parse(a)},string:function(a){a=atob(a);return pako.inflate(a,{to:"string"})}};
$.fn.animateRotate=function(a,d,b,e,c){var f=$.speed(b,e,c),g=f.step;return this.each(function(b,c){f.complete=$.proxy(f.complete,c);f.step=function(a){$.style(c,"transform","rotate("+a+"deg)");if(g)return g.apply(c,arguments)};$({deg:a}).animate({deg:d},f)})};Crazyerics.prototype._asyncLoop=function(a,d,b){var e=0,c=!1,f={next:function(){c||(e<a?(e++,d(f)):(c=!0,b()))},iteration:function(){return e-1},"break":function(){c=!0;b()}};f.next();return f};var crazyerics=new Crazyerics;