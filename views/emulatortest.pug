doctype html
html(lang='en')
    head
        meta(charset='utf-8')
        title RetroArch Web Player
        script(type='text/javascript', src='/javascripts/browserfs.min.js')
        style.
            .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
            textarea.emscripten { border: 0px; font-family: 'Share Tech Mono'; font-size: 12px; width: 100%; overflow:hide; resize:none; color:black; }
            div.emscripten, h1 { text-align: left; }
            div.canvas_border { background-color:gray; width:800px; height:600px; margin-left: auto; margin-right: auto; }
            canvas.emscripten { border: 0px none; }
    body
        hr
        #canvas_div.emscripten_border(style='display: none')
            canvas#canvas.emscripten(tabindex='1', oncontextmenu='event.preventDefault()')
        #openrom.emscripten.emscripten_border
            button#btnLoad(onclick="document.getElementById('rom').click()") Upload Content
            input#rom(style='display: none', type='file', name='upload', onclick="document.getElementById('btnLoad').click();", onchange='runEmulator(event.target.files);', multiple='')
            button#btnStart(onclick='startRetroArch()') Start RetroArch
        hr
        .emscripten
            input#resize(type='checkbox')
            label(for='resize') Resize canvas
            input#pointerLock(type='checkbox', checked='')
            label(for='pointerLock') Lock/hide mouse pointer
            input(type='button', value='Fullscreen', onclick="Module.requestFullScreen(document.getElementById('pointerLock').checked, document.getElementById('resize').checked)")
            br
            input#vsync(type='checkbox')
            label#vsync-label(for='vsync') Enable V-sync (can only be done before loading game)
            br
            input#sdl2(type='checkbox')
            label#sdl2-label(for='sdl2') Enable SDL2
            br
            input#latency(type='textbox', size='3', maxlength='3', value='96')
            label#latency-label(for='latency')
                | Audio latency (ms) (increase if you hear pops at fullspeed, can only be done before loading game)
        hr
        textarea#output.emscripten(rows='8')
        hr
        #controls.emscripten
            | Controls:
            br
            br
            |       A button (OK in menu): X
            br
            |       B button (Back in menu): Z
            br
            |       X Button: S
            br
            |       Y Button: A
            br
            |       L Button: Q
            br
            |       R Button: W
            br
            |       D-pad: Arrow Keys
            br
            |       Start Button: Enter
            br
            |       Select Button: Shift
            br
            |       Toggle Menu: F1
            br
            |       Fast forward: Spacebar (toggle)
            br
            |       Slow motion: E (hold)
            br
            |       Save state: F2
            br
            |       Load state: F4
            br

        script(type='text/javascript').
            var count = 0;

            function runEmulator(files) {
                count = files.length;
                document.getElementById("openrom").innerHTML = '';
                document.getElementById("openrom").style.display = 'none';
                for (var i = 0; i < files.length; i++) {
                    filereader = new FileReader();
                    filereader.file_name = files[i].name;
                    filereader.onload = function() {
                        uploadData(this.result, this.file_name)
                    };
                    filereader.readAsArrayBuffer(files[i]);
                }
            }

            function startRetroArch() {
                Module.FS_createFolder('/', 'etc', true, true);
                Module.FS_createFolder('/', 'config', true, true);
                Module.FS_createFolder('/', 'content', true, true);
                Module.FS_createFolder('/', 'savefiles', true, true);
                Module.FS_createFolder('/', 'savestates', true, true);
                var config = 'input_player1_select = shift\\n';
                var latency = parseInt(document.getElementById('latency').value, 10);
                if (isNaN(latency)) latency = 96;
                config += 'audio_latency = ' + latency + '\\n'
                if (document.getElementById('vsync').checked)
                    config += 'video_vsync = true\\n';
                else
                    config += 'video_vsync = false\\n';
                Module.FS_createDataFile('/etc', 'retroarch.cfg', config, true, true);
                document.getElementById('canvas_div').style.display = 'block';
                document.getElementById('vsync').disabled = true;
                document.getElementById('vsync-label').style.color = 'gray';
                document.getElementById('latency').disabled = true;
                document.getElementById('latency-label').style.color = 'gray';
                Module['callMain'](Module['arguments']);
            }

            function uploadData(data, name) {
                var dataView = new Uint8Array(data);
                Module.FS_createDataFile('/', name, dataView, true, false);
                startRetroArch();
            }
            var Module = {
                noInitialRun: true,
                arguments: ["-v", "--menu"],
                preRun: [],
                postRun: [],
                print: (function() {
                    var element = document.getElementById('output');
                    element.value = ''; // clear browser cache
                    return function(text) {
                        text = Array.prototype.slice.call(arguments).join(' ');
                        element.value += text + "\\n";
                        element.scrollTop = 99999; // focus on bottom
                    };
                })(),
                printErr: function(text) {
                    var text = Array.prototype.slice.call(arguments).join(' ');
                    var element = document.getElementById('output');
                    element.value += text + "\\n";
                    element.scrollTop = 99999; // focus on bottom
                },
                canvas: document.getElementById('canvas'),
                totalDependencies: 0,
                monitorRunDependencies: function(left) {
                    this.totalDependencies = Math.max(this.totalDependencies, left);
                }
            };
        script(type='text/javascript', src='/emulators/2016-10-20_RetroArch/#{emuname}.js')